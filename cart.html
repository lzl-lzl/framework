<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>cart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.0.2/css/bootstrap.min.css"> -->
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://unpkg.com/tween.js@16.3.4"></script>
    <script src="https://cdn.bootcss.com/vue/2.2.3/vue.min.js"></script>
    <style>
        thead th:nth-child(2){
            min-width:120px;
            max-width: 200px;
            padding-bottom:0!important; 
        }
        thead .glyphicon{
            padding-right: 6px;
        }
        th .glyphicon-sort-by-attributes,th .glyphicon-sort-by-attributes-alt{
            color: #337ab7;
            margin-top: 2px;
        }

    </style>
</head>

<body>

    <header class="navbar navbar-static-top custom-nav">
        <div class="container">
            <div class="navbar-header">
                <a href="#" class="navbar-brand">Vue & cssUI</a>
            </div>
            <nav class="collapse navbar-collapse">
                <ul class='nav navbar-nav'>
                    <li><a href="./router.html">列表</a></li>
                    <li><a href='./confirm.html'>确认页</a></li>
                    <li><a href='./modified.html'>修改页</a></li>
                    <li><a href='./showdetail.html'>展示页1</a></li>
                    <li><a href='./workflow.html'>展示页2</a></li>
                    <li><a href='./cart.html'>购物车</a></li>
                    <li><a href="./form.html">表单页</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#">官网</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <div class="jumbotron cus-jumb">
        <div class="container">
            <h1>V&B</h1>
            <blockquote>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.</p>
                <footer class="text-uppercase"><strong>Someone famous</strong> <em>in</em> <cite title="Source Title">Source Title</cite></footer>
            </blockquote>
        </div>
    </div>

    <div class="container">
        <section class='row'>
        
             <!-- <div id="app" >class="container"  -->
            <div id="app" >
                
                <table class="table">
                
                    <thead>
                    
                        <tr>
                        
                            <th>
                                <span class="glyphicon glyphicon-align-left" aria-hidden="true"></span>
                                产品编号
                                <span v-show = 'sort'  @click='sort=!sort;arraySort(true)'
                                class="glyphicon glyphicon-sort-by-attributes-alt pull-right"></span>
                                <span v-show = '!sort' @click='sort=!sort;arraySort(false)'
                                class="glyphicon glyphicon-sort-by-attributes pull-right"></span>
                            </th>
                        
                            <th>    
                                <div class="input-group">
                                    <span class="input-group-btn">
                                        
                                        <button class="btn btn-default" type="button" style="border-bottom:none">
                                            <span class="glyphicon glyphicon-tag" aria-hidden="true" ></span>
                                            名字
                                        </button>
                                    </span>
                                    <input type="text" placeholder="" v-model='filterVal'
                                    class="form-control" style="border-bottom:none"
                                    @keyup='handlefilter(filterVal);filterName=false;' 
                                    @blur=''>
                                </div>

                                <!-- <div v-show='filterName' @click='handleshow'>
                                    <span class="glyphicon glyphicon-tag" aria-hidden="true" ></span>
                                    名字
                                </div> -->

                                <!-- <div v-show='!filterName' class='col-sm-10' @blur='filterName=!filterName;'> -->
                                <!-- <div  class='col-sm-10'>
                                    <input type="text" class="form-control"  v-model='filterVal' ref="filt"
                                      @keyup='handlefilter(filterVal)'
                                     placeholder='输入...'>
                                </div> -->
                            </th>
                        
                            <th><span class="glyphicon glyphicon-inbox"></span>购买数量</th>
                        
                            <th><span class="glyphicon glyphicon-usd"></span>产品单价</th>
                        
                            <th><span class="glyphicon glyphicon-jpy"></span>产品总价</th>
                        
                            <th><span class="glyphicon glyphicon-wrench"></span>操作</th>
                            </tr>
                        </thead>
                
                    <tbody>
                    
                        <tr v-for="(item , index) in filteredList">
                        
                            <td @click="jia(index)">{{item.id}}</td>
                        
                            <td>{{item.name}}</td>
                        
                            <td class='row'>
                                <div class="col-sm-6">
                                     <input class="form-control" type="number" v-model="item.quantity">
                                </div>
                                <div class="btn-group btn-group-sm col-xs-6" role="group" aria-label="...">
                                    <button type="button" class="btn btn-primary" @click="subtract(index)">
                                        <span class="glyphicon glyphicon-minus"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" @click="add(index)">
                                        <span class="glyphicon glyphicon-plus"></span> 
                                    </button>
                                </div>       
                            </td>
                        
                            <td>{{item.price | filtermoney}}</td>
                        
                            <!--<td>{{arr[index].one}}</td>-->
                        
                            <td>{{item.price*item.quantity | filtermoney}}</td>
                        
                            <td>
                                <button type="button" class="btn btn-danger" @click="remove(index)">移除</button>
                            </td>
                            </tr>

                        <tr id='editlzl' v-show='isNew'>
                            <td class='row'>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="basic-url" v-model="newitem.id" aria-describedby="basic-addon3">
                                    <span class="input-group-addon" id="basic-addon3" >编号</span>
                                </div>
                            </td> 
                            <td class='row'> 
                                <div class="input-group">
                                    <input type="text" class="form-control" v-model="newitem.name">
                                    <span class="input-group-addon" >名字</span>
                                </div>
                            </td> 
                            <td class='row'>
                                <div class="col-sm-6">
                                    <input class="form-control col-sm-3" type="text" 
                                    v-model="newitem.quantity" number>
                                </div>
                                <div class="btn-group btn-group-sm col-xs-6" role="group" aria-label="...">
                                    <button type="button" class="btn btn-primary" @click="subtractNew(newitem.quantity)">
                                        <span class="glyphicon glyphicon-minus"></span>
                                    </button>
                                    <button type="button" class="btn btn-primary" @click="addNew(newitem.quantity)">
                                        <span class="glyphicon glyphicon-plus"></span> 
                                    </button>
                                </div> 
                            </td> 
                            <td class='row'>
                                <div class="input-group col-sm-10">
                                    <input type="text" class="form-control" v-model="newitem.price"  type="number">
                                    <span class="input-group-addon">价格</span>
                                </div>
                            </td> 
                            <td class='row'>
                                 {{itemTotalPrice|filtermoney}}
                            </td> 
                            <td>
                                <!-- <div class="btn-group btn-group-sm"> -->
                                <div class="btn-group">
                                    <button class="btn btn-info" type="" @click='submitNewOne'>确定</button>
                                    <!-- <button class="btn btn-primary" type="submit">sunmit</button> -->
                                </div>
                            </td>
                        </tr>


                        <tr v-show='filterName' >
                        
                            <td>总购买价
                            </td>
                        
                            <td>
                                {{animatenum | filtermoney}}
                            </td>
                        
                            <td>
                                总购买数量  {{computedTotalNum}}
                            </td>
                        
                            <td>
                              
                            </td>
                        
                            
                            <td>
                            
                            </td>

                            <td>
                                
                                <!-- <button type="button" class="btn btn-danger" @click="empty()">清空购物车</button> -->
                            </td>
                            </tr>

                            <tr>
                                <td colspan="6" style="text-align:center"> 
                                    <button type="" class="btn btn-danger" @click="isNew=true">新增</button>
                                    <button type="reset" class="btn btn-danger" @click="empty()">清空</button>      
                                </td>
                            </tr>
                        </tbody>
                    </table>
            
                <p v-if="message.length===0">您的购物车为空</p>
                </div>
        </section>
    </div>

    <script>
        var vm = new Vue({
            el: "#app",
            data: {
                newitem:{
                    id:null,
                    name:null,
                    price:null,
                    quantity:null
                },
                filteredList:null,
                sort:true,
                isNew:false,
                filterName:true,
                totalPrice: 0,
                totalNum:0,
                animatenum: 0,
                filterVal:null,
                message: [
                    {
                        id: 007,
                        name: 'iphone5s',
                        quantity: 3,
                        price: 4000
                    }, {
                        id: 1340,
                        name: 'iphone5',
                        quantity: 9,
                        price: 3000
                    }, {
                        id: 7758,
                        name: 'imac',
                        quantity: 4,
                        price: 7000
                    }, {
                        id: 2017,
                        name: 'ipad',
                        quantity: 5,
                        price: 6000
                    }
                ]
               },
            watch: {
                toComput2: function (newValue, oldValue) {
                    this.tween(newValue, oldValue);
                }
                ,computedTotalNum:function(){
                    console.log('computedTotalNum_changed');
                }
                // ,newitem:function(){???
                //     console.log('newitem_changed')
                //     computedTotalNum =0
                // }
                // ,
                // computedTotalNum:function (newValue, oldValue) {
                //     this.tween(newValue, oldValue);
                // }
           },
            computed: {
                itemTotalPrice:function(){
                    return this.newitem.quantity * this.newitem.price
                },
                computedTotalNum:function(){
                    this.totalNum = 0;
                    this.message.forEach(function(mes){
                        this.totalNum += parseInt(mes.quantity);
                    }.bind(this))
                    this.totalNum += this.newitem.quantity && parseInt(this.newitem.quantity);
                    return this.totalNum;
                },
                // computedTotalPrice:function(){
                //     var messageQuantity = this.message.reduce(function(prev,next){
                //         return prev.quantity+next;
                //     })
                //     return this.message.quantity+this.newitem.quantity
                // },
                // itemchanged:function(){
                //     return this.newitem.quantity;
                // },
                //计算总金额
                toComput2: function () {
                    var vm = this;
                    //每次进来要重置总金额
                    vm.totalPrice = 0;
                    this.message.forEach(function (mess) {
                        vm.totalPrice += parseInt(mess.price * mess.quantity);
                    })
                    return this.totalPrice;
                 }
            },
            created:function(){
                this.filteredList = this.message;
            },
            filters: {
                filtermoney: function (value) {
                    return '￥' + value;
                }
            },
            mounted: function () {
                this.message.forEach(function (mess) {
                    this.totalPrice += parseInt(mess.price * mess.quantity);
                })
                this.tween(this.totalPrice, '0');
           },
            methods: {
                handleshow:function(){
                    this.filterName=!this.filterName;
                    // document.getElementById('filt').focus();
                    this.$refs.filt.click();
                    this.$refs.filt.innerHTML='true';
                    // this.$refs.filt.disabled=true;
                },
                handlefilter:function(val){
                    // debugger;
                    if(!val.trim()){
                        this.filteredList = this.message;
                    }
                   
                    this.filteredList = this.message.filter(function(ele){
                        return ele['name'].indexOf(val)>-1;
                    })
                     
                    console.log(this.filteredList);
                },
                arraySort:function(flag){
                    if(flag){
                        this.filteredList.sort(
                            function(itemA,itemB){
                                return itemA.id > itemB.id
                            }
                        );
                    }else{
                        this.filteredList.sort(
                            function(itemA,itemB){
                                return itemA.id < itemB.id
                            }
                        )
                        // ).reverse();
                    }
                    
                },
                //handle newItem
                subtractNew:function(val){
                    // console.log(this.newitem);
                    if(parseInt(val)>0){
                        this.newitem.quantity--;
                    }else{
                        this.newitem.quantity = 0;
                    }
                },
                addNew:function (val) {
                    this.newitem.quantity++;
                    // console.log(this.newitem.quantity);
                },
                submitNewOne:function(){
                    this.message.push(JSON.parse(JSON.stringify(this.newitem)));
                    for(var key in this.newitem){
                        this.newitem[key]=null;
                    }
                     console.log(this.newitem);
                },
                    //计算总数的方法为什么写在methods里面就不行？
                toComput: function () {
                    var vm = this;
                    vm.message.forEach(function (mess) {
                        vm.totalPrice += parseInt(mess.price * mess.quantity);
                    })
                    return vm.totalPrice;
                    },
                add: function (index) {
                    var vm = this;
                    vm.message[index].quantity++;
                },
                subtract: function (index) {
                    var vm = this;
                    vm.message[index].quantity--;
                    if (vm.message[index].quantity <= 0) {
                        if (confirm("你确定移除该商品？")) {
                            vm.message.splice(index, 1)
                        }
                    }
                },
                remove: function (index) {
                    var vm = this;
                    if (confirm("你确定移除该商品？")) {
                        vm.message.splice(index, 1)
                    }
                },
                empty: function () {
                    var vm = this;
                    vm.message.splice(0, vm.message.length);
                },
                jia: function (index) {
                    var vm = this;
                    vm.arr[index].one++;
                },
                tween: function (newValue, oldValue) {
                    var vm = this;
                    var twen = new TWEEN.Tween({ animatenum: oldValue });
                    function animate() {
                        requestAnimationFrame(animate);
                        TWEEN.update();
                };
                twen.to({ animatenum: newValue }, 750);
                twen.onUpdate(function () {
                    //toFixed();保留几位小数
                    vm.animatenum = this.animatenum.toFixed();
                })
                twen.start();
                animate();
                }
               }
           });
    </script>
</body>

</html>